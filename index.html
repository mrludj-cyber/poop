<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ëŒì¥ì˜ ì„¸ê³„ ì •ë³µê¸° ğŸ¿ï¸</title>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body, html { height: 100%; margin: 0; padding: 0; font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f5f5f5; overflow: hidden; }
        
        /* --- ì¸íŠ¸ë¡œ í™”ë©´ --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFF8E1; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
        }
        .intro-container { position: relative; width: 300px; height: 400px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 50px; }
        .intro-globe { width: 140px; height: 140px; z-index: 1; animation: spin 10s linear infinite; margin-bottom: 20px; }
        .intro-squirrel { position: absolute; bottom: 205px; width: 200px; left: 50px; right: 0; margin-left: auto; margin-right: auto; z-index: 2; animation: walk 0.6s ease-in-out infinite alternate; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
        @keyframes walk { from { transform: translateY(0) rotate(-5deg); } to { transform: translateY(-15px) rotate(5deg); } }
        .intro-text { margin-top: 20px; font-size: 22px; font-weight: bold; color: #8B4513; text-align: center; line-height: 1.5; }

        /* --- UI ìš”ì†Œ --- */
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 10; }
        .tab-item { flex: 1; text-align: center; padding: 10px; font-size: 14px; color: #888; cursor: pointer; }
        .tab-item.active { color: #8B4513; font-weight: bold; }
        .tab-icon { display: block; font-size: 20px; margin-bottom: 2px; }

        #map-container { height: calc(100% - 60px); width: 100%; position: absolute; top: 0; }
        #list-container { height: calc(100% - 60px); width: 100%; position: absolute; top: 0; background: #fdfdfd; display: none; overflow-y: auto; padding-bottom: 20px; }

        /* ë©”ì¸ ë²„íŠ¼ (ì •ë³µ ì‹œì‘) */
        #conquer-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 5; background-color: #8B4513; color: white;
            border: 3px solid #D2691E; padding: 15px 30px; font-size: 18px;
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; white-space: nowrap;
        }
        #conquer-btn:active { transform: translateX(-50%) scale(0.95); background-color: #5D2906; }

        /* ìœ„ì¹˜ í™•ì • ë²„íŠ¼ (ì¡°ì • í›„ ì €ì¥) */
        #confirm-btn {
            display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 6; background-color: #228B22; color: white;
            border: 3px solid #006400; padding: 15px 30px; font-size: 18px;
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            font-weight: bold; cursor: pointer; white-space: nowrap;
        }

        /* ì•ˆë‚´ ë¬¸êµ¬ (ìœ„ì¹˜ ì¡°ì • ì‹œ) */
        #guide-msg {
            display: none;
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); padding: 10px 20px; border-radius: 20px;
            font-weight: bold; color: #8B4513; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 5;
            text-align: center; width: 80%;
        }

        /* --- ì •ë³µ ì•¡ì…˜ ì• ë‹ˆë©”ì´ì…˜ (CSSë¡œ êµ¬í˜„) --- */
        #action-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .action-squirrel {
            font-size: 80px;
            animation: shakeButt 0.5s ease-in-out infinite;
        }
        .action-acorn {
            font-size: 40px;
            opacity: 0;
            margin-top: -20px;
            animation: dropAcorn 1s ease-out forwards;
            animation-delay: 1s; /* ë‹¤ëŒì¥ í”ë“¤ê³  1ì´ˆ ë’¤ì— ë–¨ì–´ì§ */
        }
        @keyframes shakeButt {
            0% { transform: rotate(0deg) translateY(0); }
            25% { transform: rotate(-10deg) translateY(5px); }
            75% { transform: rotate(10deg) translateY(5px); }
            100% { transform: rotate(0deg) translateY(0); }
        }
        @keyframes dropAcorn {
            0% { transform: translateY(-20px) scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px) scale(1.2); opacity: 1; }
        }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .stats-box { background: #8B4513; color: white; padding: 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .stats-count { font-size: 28px; font-weight: bold; }
        .log-item { background: white; margin: 15px; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .log-place { font-weight: bold; font-size: 18px; color: #333; }
        .log-note { background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 14px; color: #555; border-left: 3px solid #8B4513; }
        .btn-edit { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; background: none; border: none; }

        /* ëª¨ë‹¬ */
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 80%; }
        .modal-input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; }
        .btn-save { background: #8B4513; color: white; }
    </style>
</head>
<body>

    <!-- ì¸íŠ¸ë¡œ -->
    <div id="intro-screen">
        <div class="intro-container">
            <img src="./squirrel.png" class="intro-squirrel" alt="ë‹¤ëŒì¥">
            <img src="./globe.png" class="intro-globe" alt="ì§€êµ¬ë³¸">
        </div>
        <div class="intro-text">
            ì§€êµ¬ ì •ë³µí•˜ëŸ¬<br>ì¶œë™í•œë‹¤ëŒì¥! ğŸ¿ï¸ğŸ’¨
        </div>
    </div>

    <!-- ì •ë³µ ì•¡ì…˜ ì• ë‹ˆë©”ì´ì…˜ ì˜¤ë²„ë ˆì´ -->
    <div id="action-overlay">
        <div class="action-squirrel">ğŸ¿ï¸</div>
        <div class="action-acorn">ğŸŒ°</div>
        <div style="color:white; font-weight:bold; margin-top:20px; font-size:20px;">ì˜ì—­ í‘œì‹œ ì¤‘...</div>
    </div>

    <!-- ì§€ë„ íƒ­ -->
    <div id="map-container">
        <div id="map" style="width: 100%; height: 100%;"></div>
        
        <div id="guide-msg">ì› ì•ˆì—ì„œ ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•´<br>ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì°ì–´ì£¼ì„¸ìš”!</div>
        
        <button id="conquer-btn" onclick="startConquestMode()">
            <span>ğŸš©</span> ì •ë³µí•˜ê¸°
        </button>
        
        <button id="confirm-btn" onclick="confirmLocationAndSave()">
             ğŸ™†â€â™‚ï¸ ì—¬ê¸°ë¡œ í™•ì •!
        </button>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ íƒ­ -->
    <div id="list-container">
        <div class="stats-box">
            <div style="font-size: 14px; opacity: 0.9;">í˜„ì¬ ë‹¤ëŒì¥ì˜ ì •ë³µ í˜„í™©</div>
            <div class="stats-count" id="total-count">0ê³³ ì •ë³µí•¨</div>
            <div style="margin-top: 10px; font-size: 14px;" id="country-stats"></div>
        </div>
        <div id="log-list-area"></div>
    </div>

    <!-- í•˜ë‹¨ íƒ­ë°” -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('map')" id="tab-map">
            <span class="tab-icon">ğŸ—ºï¸</span>ì§€ë„
        </div>
        <div class="tab-item" onclick="switchTab('list')" id="tab-list">
            <span class="tab-icon">ğŸ“œ</span>ì •ë³µ ë¦¬ìŠ¤íŠ¸
        </div>
    </div>

    <!-- ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#8B4513;">ì •ë³µ ê¸°ë¡ ìˆ˜ì • ğŸ¿ï¸</h3>
            <input type="text" id="edit-place" class="modal-input" placeholder="ì¥ì†Œ ì´ë¦„">
            <textarea id="edit-note" class="modal-input" rows="3" placeholder="ë©”ëª¨"></textarea>
            <input type="hidden" id="edit-id">
            <div class="modal-btns">
                <button class="modal-btn" onclick="closeModal()" style="background:#ddd;">ì·¨ì†Œ</button>
                <button class="modal-btn btn-save" onclick="saveEdit()">ì €ì¥</button>
            </div>
            <button onclick="deleteLog()" style="margin-top:10px; width:100%; background:none; border:none; color:red; cursor:pointer;">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5LgbtPjepR9nuQ4TUjyRknmC9JgKodWo&libraries=places&callback=initMap">
    </script>

    <script>
        let map;
        let geocoder;
        let activeSelectionMarker = null; // ìœ„ì¹˜ ì¡°ì •ìš© ë§ˆì»¤
        let activeCircle = null;          // 100m ë°˜ê²½ ì›

        function initMap() {
            setTimeout(() => {
                document.getElementById('intro-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('intro-screen').style.display = 'none'; }, 1000);
            }, 3000);

            geocoder = new google.maps.Geocoder();
            // ê¸°ë³¸ ì„œìš¸ ì¢Œí‘œ
            const startPos = { lat: 37.5665, lng: 126.9780 };
            
            // 1. [ìš”ì²­ë°˜ì˜] zoomì„ 17ë¡œ ì„¤ì •í•˜ì—¬ ì´ˆê¸°ë¶€í„° ìƒì„¸í•˜ê²Œ(ë™/ê±´ë¬¼ ë‹¨ìœ„) ë³´ì´ê²Œ í•¨
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 17, 
                center: startPos, 
                disableDefaultUI: false, 
                clickableIcons: false,
                streetViewControl: false, // ëª¨ë°”ì¼ì—ì„œ ê¹”ë”í•˜ê²Œ ë³´ì´ê¸° ìœ„í•´
                mapTypeControl: false
            });

            loadConquests(); // ì €ì¥ëœ ë„í† ë¦¬ë“¤ ë¶ˆëŸ¬ì˜¤ê¸°

            // í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    map.setCenter(pos);
                    // í˜„ì¬ ë‚´ ìœ„ì¹˜ í‘œì‹œ (ë‹¤ëŒì¥)
                    new google.maps.Marker({ 
                        position: pos, 
                        map: map, 
                        label: { text: "ğŸ¿ï¸", fontSize: "30px" }, 
                        zIndex: 999 
                    });
                });
            }
        }

        // --- 2. [ìš”ì²­ë°˜ì˜] ì •ë³µ ëª¨ë“œ ì‹œì‘ (ìœ„ì¹˜ ì¡°ì • ë‹¨ê³„) ---
        function startConquestMode() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            
            navigator.geolocation.getCurrentPosition((position) => {
                const currentLat = position.coords.latitude;
                const currentLng = position.coords.longitude;
                const currentPos = { lat: currentLat, lng: currentLng };

                map.setCenter(currentPos);
                map.setZoom(18); // ì¡°ì •í•˜ê¸° ì‰½ê²Œ ë” í™•ëŒ€

                // ì´ë¯¸ ì¡°ì • ì¤‘ì´ë©´ ë¦¬ì…‹
                if(activeSelectionMarker) activeSelectionMarker.setMap(null);
                if(activeCircle) activeCircle.setMap(null);

                // 2. [ìš”ì²­ë°˜ì˜] 100m ë°˜ê²½ ì› ê·¸ë¦¬ê¸°
                activeCircle = new google.maps.Circle({
                    strokeColor: "#8B4513",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#8B4513",
                    fillOpacity: 0.15,
                    map: map,
                    center: currentPos,
                    radius: 100 // 100ë¯¸í„°
                });

                // 2. [ìš”ì²­ë°˜ì˜] ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë§ˆì»¤ ìƒì„±
                activeSelectionMarker = new google.maps.Marker({
                    position: currentPos,
                    map: map,
                    draggable: true, // ë“œë˜ê·¸ ê°€ëŠ¥!
                    label: { text: "ğŸŒ°", fontSize: "40px" }, // 3. [ìš”ì²­ë°˜ì˜] ë„í† ë¦¬ ì•„ì´ì½˜
                    animation: google.maps.Animation.DROP
                });

                // UI ë³€ê²½ (ì •ë³µë²„íŠ¼ ìˆ¨ê¸°ê³ , í™•ì •ë²„íŠ¼ í‘œì‹œ)
                document.getElementById('conquer-btn').style.display = 'none';
                document.getElementById('confirm-btn').style.display = 'block';
                document.getElementById('guide-msg').style.display = 'block';

            }, () => {
                alert("GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        // --- ìœ„ì¹˜ í™•ì • ë° ì €ì¥ ---
        function confirmLocationAndSave() {
            if(!activeSelectionMarker) return;

            // ìµœì¢… ì„ íƒëœ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            const finalPos = activeSelectionMarker.getPosition();
            const lat = finalPos.lat();
            const lng = finalPos.lng();

            // 4. [ìš”ì²­ë°˜ì˜] CSS ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (GIF ëŒ€ì‹ )
            const overlay = document.getElementById('action-overlay');
            overlay.style.display = 'flex';

            // 2ì´ˆ ë’¤ì— ë°ì´í„° ì €ì¥ ë° UI ë³µê·€
            setTimeout(() => {
                saveData(lat, lng);
                overlay.style.display = 'none';
                
                // UI ë³µê·€
                document.getElementById('conquer-btn').style.display = 'flex';
                document.getElementById('confirm-btn').style.display = 'none';
                document.getElementById('guide-msg').style.display = 'none';
                
                // ì¡°ì •ìš© ë§ˆì»¤/ì› ì œê±°
                activeSelectionMarker.setMap(null);
                activeCircle.setMap(null);
                activeSelectionMarker = null;
                activeCircle = null;

            }, 2500); // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ ì–¼ì¶” ë§ì¶¤
        }

        function saveData(lat, lng) {
            // ìœ„ì¹˜ ê¸°ë°˜ ì£¼ì†Œ ë³€í™˜ (Geocoding)
            geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                let country = "ë¯¸ì§€ì˜ ë•…", region = "ì–´ë”˜ê°€", flag = "ğŸ³ï¸";
                
                if (status === "OK" && results[0]) {
                    // ì£¼ì†Œ êµ¬ì„±ìš”ì†Œ ë¶„ì„
                    results[0].address_components.forEach(comp => {
                        if (comp.types.includes("country")) {
                            country = comp.long_name;
                            if(country === "ëŒ€í•œë¯¼êµ­") flag = "ğŸ‡°ğŸ‡·";
                            else if(country === "ë¯¸êµ­") flag = "ğŸ‡ºğŸ‡¸";
                            else if(country === "ì¼ë³¸") flag = "ğŸ‡¯ğŸ‡µ";
                            else flag = "ğŸš©";
                        }
                        // 1. [ìš”ì²­ë°˜ì˜] í–‰ì •êµ¬ì—­ ëª…ì¹­ (ì‹œ/ë„ í˜¹ì€ êµ¬/êµ°)
                        if (comp.types.includes("administrative_area_level_1") || comp.types.includes("locality")) {
                             region = comp.long_name;
                        }
                        // ë™/ì/ë©´ ì •ë³´ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ region ë®ì–´ì“°ê¸° (ë” ìƒì„¸í•˜ê²Œ)
                        if (comp.types.includes("sublocality_level_2") || comp.types.includes("neighborhood")) {
                             region = comp.long_name;
                        }
                    });
                }

                const newConquest = {
                    id: Date.now(),
                    lat: lat, 
                    lng: lng,
                    time: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString(),
                    country: country,
                    region: region, // ë™ ë‹¨ìœ„ í˜¹ì€ êµ¬ ë‹¨ìœ„
                    flag: flag,
                    placeName: `${region}ì˜ ë„í† ë¦¬`, // ê¸°ë³¸ ì´ë¦„
                    note: "ì˜ì—­ í‘œì‹œ ì™„ë£Œ! ë“ ë“ í•˜ë‹¤."
                };

                let list = getList();
                list.push(newConquest);
                saveList(list);
                
                addMarker(newConquest); // ì§€ë„ì— ê³ ì • ë§ˆì»¤ ì¶”ê°€
                if(navigator.vibrate) navigator.vibrate(200);
            });
        }

        // ì§€ë„ì— ë§ˆì»¤ ì°ê¸° (ì €ì¥ëœ ë°ì´í„°)
        function addMarker(data) {
            const marker = new google.maps.Marker({
                position: { lat: data.lat, lng: data.lng },
                map: map,
                // 3. [ìš”ì²­ë°˜ì˜] ë˜¥(ğŸ’©) ëŒ€ì‹  ë„í† ë¦¬(ğŸŒ°) ì•„ì´ì½˜ ì‚¬ìš©
                label: { text: "ğŸŒ°", fontSize: "20px" } 
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<div style="text-align:center; padding:5px;">
                            <div style="font-size:16px; font-weight:bold;">${data.placeName}</div>
                            <div style="font-size:12px; color:#555;">${data.time}</div>
                          </div>`
            });

            marker.addListener("click", () => infoWindow.open(map, marker));
        }

        /* --- ë°ì´í„° ê´€ë¦¬ (localStorage) --- */
        function getList() { return JSON.parse(localStorage.getItem('conquestList')) || []; }
        function saveList(list) { localStorage.setItem('conquestList', JSON.stringify(list)); renderList(); }
        
        function loadConquests() {
            getList().forEach(item => addMarker(item));
            renderList();
        }

        function renderList() {
            const list = getList().reverse();
            const container = document.getElementById('log-list-area');
            container.innerHTML = "";
            document.getElementById('total-count').innerText = `${list.length}ê°œì˜ ë„í† ë¦¬ ì‹¬ìŒ`;
            
            const countryCounts = {};
            list.forEach(item => { countryCounts[item.country] = (countryCounts[item.country] || 0) + 1; });
            
            let statsText = [];
            for (const [country, count] of Object.entries(countryCounts)) statsText.push(`${country} ${count}`);
            document.getElementById('country-stats').innerText = statsText.join('  |  ');

            list.forEach(item => {
                const div = document.createElement('div'); div.className = 'log-item';
                div.innerHTML = `
                    <div class="log-header">
                        <div><span style="font-size:24px; margin-right:5px;">${item.flag}</span> <span class="log-place">${item.placeName}</span></div>
                        <button class="btn-edit" onclick="openEditModal(${item.id})">âœ</button>
                    </div>
                    <div style="font-size:12px; color:#777; margin-bottom:8px;">${item.country} ${item.region} | ${item.time}</div>
                    <div class="log-note">${item.note}</div>
                `;
                container.appendChild(div);
            });
        }

        /* --- ëª¨ë‹¬ ë° íƒ­ ê¸°ëŠ¥ (ê¸°ì¡´ ë™ì¼) --- */
        function openEditModal(id) {
            const item = getList().find(x => x.id === id);
            if(item) {
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-place').value = item.placeName;
                document.getElementById('edit-note').value = item.note;
                document.getElementById('edit-modal').style.display = 'flex';
            }
        }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        
        function saveEdit() {
            const id = parseInt(document.getElementById('edit-id').value);
            let list = getList();
            const index = list.findIndex(x => x.id === id);
            if(index !== -1) {
                list[index].placeName = document.getElementById('edit-place').value;
                list[index].note = document.getElementById('edit-note').value;
                saveList(list); closeModal();
            }
        }
        
        function deleteLog() {
            if(confirm("ì´ ë„í† ë¦¬ë¥¼ íŒŒë‚´ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const id = parseInt(document.getElementById('edit-id').value);
                let list = getList();
                list = list.filter(x => x.id !== id);
                saveList(list); closeModal(); location.reload();
            }
        }
        
        function switchTab(tabName) {
            if (tabName === 'map') {
                document.getElementById('map-container').style.display = 'block';
                document.getElementById('list-container').style.display = 'none';
                document.getElementById('tab-map').classList.add('active');
                document.getElementById('tab-list').classList.remove('active');
            } else {
                document.getElementById('map-container').style.display = 'none';
                document.getElementById('list-container').style.display = 'block';
                document.getElementById('tab-map').classList.remove('active');
                document.getElementById('tab-list').classList.add('active');
                renderList();
            }
        }
    </script>
</body>
</html>
