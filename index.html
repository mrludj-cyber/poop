<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ëŒì¥ì˜ ì„¸ê³„ ì •ë³µê¸° ğŸ¿ï¸</title>

    <!-- [1] ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì—°ê²° (ì•ˆë“œë¡œì´ë“œìš©) -->
    <link rel="manifest" href="./manifest.json">

    <!-- [2] ì•„ì´í°(iOS) ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes"> <!-- ì£¼ì†Œì°½ ì œê±° -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- ìƒíƒœë°” íˆ¬ëª…í•˜ê²Œ -->
    <meta name="apple-mobile-web-app-title" content="ë‹¤ëŒì¥ì •ë³µ">
    
    <!-- [3] ì•„ì´í° í™ˆ í™”ë©´ ì•„ì´ì½˜ ì„¤ì • -->
    <link rel="apple-touch-icon" href="./squirrel.png">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body, html { height: 100%; margin: 0; padding: 0; font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f5f5f5; overflow: hidden; }
        
        /* --- ì¸íŠ¸ë¡œ í™”ë©´ --- */
        /* --- ì¸íŠ¸ë¡œ í™”ë©´ --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFF8E1; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
            overflow: hidden;
        }
        .intro-container { 
            position: relative; 
            width: 320px; 
            height: 400px; 
            display: flex; 
            justify-content: center; 
            align-items: flex-end; 
            padding-bottom: 50px; 
        }
        
        /* ì§€êµ¬ë³¸: ì œìë¦¬ì—ì„œ ê³„ì† ë” */
        .intro-globe { 
            width: 130px; height: 130px; /* ì§€êµ¬ë¥¼ ì¡°ê¸ˆ ë” í‚¤ì› ìŠµë‹ˆë‹¤ */
            
            z-index: 1; 
            animation: spin 8s linear infinite; 
            margin-bottom: 10px; 
        }

        /* ìºë¦­í„° ê³µí†µ: í†µí†µ íŠ€ëŠ” ê±·ê¸° ëª¨ì…˜ */
        .intro-walker {
            position: absolute;
            bottom: 175px; /* ì§€êµ¬ë³¸ ìœ„ì— ì˜¬ë¼ê°€ë„ë¡ ìœ„ì¹˜ ì¡°ì • */
            z-index: 10;
        }

        /* [ë‹¤ëŒì¥ ëŒ€ì¥] : í™”ë©´ ì •ì¤‘ì•™ ê³ ì • */
        .intro-squirrel { 
            width: 190px; 
            left: 50%; 
            /* ì •ì¤‘ì•™ì—ì„œ ì•½ê°„ ì™¼ìª½(-70%)ìœ¼ë¡œ ì¹˜ìš°ì¹˜ê²Œ í•´ì„œ ì œì œ ìë¦¬ë¥¼ ë§Œë“¤ì–´ì¤Œ */
            transform: translateX(-70%); 
            animation: walk 0.6s ease-in-out infinite alternate;
        }

        /* [ì œì œ] : ë°–ì—ì„œ ì•ˆìœ¼ë¡œ ë“¤ì–´ì˜´ */
        .intro-jeje { 
            width: 80px; 
            left: 120%; /* í™”ë©´ ì˜¤ë¥¸ìª½ ë°”ê¹¥ì—ì„œ ì‹œì‘ */
            transform: translateX(-30%); /* ë„ì°©í–ˆì„ ë•Œ ë‹¤ëŒì¥ ë’¤ìª½ ìœ„ì¹˜ */
            animation: 
                walk 0.5s ease-in-out infinite alternate, /* ê±·ëŠ” ë™ì‘ì€ ê³„ì† */
                jeje-enter 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; /* ë“¤ì–´ì˜¤ëŠ” ë™ì‘ */
            animation-delay: 0s, 1.0s; /* ê±·ê¸°ëŠ” ë°”ë¡œ, ë“±ì¥ì€ 1ì´ˆ ë’¤ì— */
            opacity: 0; /* ì²˜ìŒì—” ì•ˆ ë³´ì„ */
        }

        /* ì§€êµ¬ íšŒì „ */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }
        
        /* ì œìë¦¬ ê±¸ìŒ (í†µí†µ íŠ€ê¸°) */
        @keyframes walk { 
            from { margin-bottom: 0px; transform: translateX(var(--tx, -50%)) rotate(-3deg); } 
            to { margin-bottom: 10px; transform: translateX(var(--tx, -50%)) rotate(3deg); } 
        }

        /* ì œì œ ë“±ì¥ ëª¨ì…˜ (ì˜¤ë¥¸ìª½ -> ë‹¤ëŒì¥ ë’¤) */
        @keyframes jeje-enter {
            0% { left: 120%; opacity: 0; }
            10% { opacity: 1; }
            100% { left: 50%; opacity: 1; margin-left: 50px; } /* ë‹¤ëŒì¥ë³´ë‹¤ ì˜¤ë¥¸ìª½(+50px)ì— ë©ˆì¶¤ */
        }

        /* ë‹¤ëŒì¥ì™€ ì œì œì˜ transform ê¸°ì¤€ì  ë§ì¶”ê¸° ìœ„í•œ ë³€ìˆ˜ ì„¤ì • */
        .intro-squirrel { --tx: -70%; }
        .intro-jeje { --tx: -30%; }

        .intro-text { 
            margin-top: 20px; font-size: 22px; font-weight: bold; 
            color: #8B4513; text-align: center; line-height: 1.5; z-index: 20;
        }

        /* --- UI ìš”ì†Œ --- */
        .tab-bar { position: fixed; bottom: 0; width: 100%; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 10; }
        .tab-item { flex: 1; text-align: center; padding: 10px; font-size: 14px; color: #888; cursor: pointer; }
        .tab-item.active { color: #8B4513; font-weight: bold; }
        .tab-icon { display: block; font-size: 20px; margin-bottom: 2px; }

        #map-container { height: calc(100% - 60px); width: 100%; position: absolute; top: 0; }
        #list-container { height: calc(100% - 60px); width: 100%; position: absolute; top: 0; background: #fdfdfd; display: none; overflow-y: auto; padding-bottom: 20px; }

        #conquer-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 5; background-color: #8B4513; color: white;
            border: 3px solid #D2691E; padding: 15px 30px; font-size: 18px;
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; white-space: nowrap;
        }
        #conquer-btn:active { transform: translateX(-50%) scale(0.95); background-color: #5D2906; }

        #confirm-group {
            display: none; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 6; flex-direction: row; gap: 10px;
        }
        .action-btn {
            padding: 15px 25px; font-size: 18px; border-radius: 50px; 
            font-weight: bold; cursor: pointer; white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); border: none;
        }
        #btn-cancel { background-color: #fff; color: #555; border: 2px solid #ccc; }
        #btn-confirm { background-color: #228B22; color: white; border: 2px solid #006400; }

        #guide-msg {
            display: none; position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); padding: 8px 15px; border-radius: 20px;
            font-size: 13px; color: #555; z-index: 5; pointer-events: none;
        }

        /* [ê°œì„ ëœ UI] ë“œë˜ê·¸ ì¤‘ ì‹¤ì‹œê°„ ì¥ì†Œ ì´ë¦„ í‘œì‹œìš© ë¼ë²¨ */
        #target-label {
            display: none;
            position: absolute;
            top: 30px; /* í™”ë©´ ìƒë‹¨ì— ê³ ì • */
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: bold;
            color: #8B4513;
            font-size: 16px;
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
            border: 3px solid #8B4513;
            transition: all 0.2s ease;
        }

        /* --- ì •ë³µ ì•¡ì…˜ ì• ë‹ˆë©”ì´ì…˜ --- */
/* --- ì •ë³µ ì•¡ì…˜ ì• ë‹ˆë©”ì´ì…˜ (ì´ë¯¸ì§€ ë²„ì „) --- */
        #action-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        
        /* ë‹¤ëŒì¥ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .action-squirrel { 
            width: 150px; /* í¬ê¸° ì¡°ì ˆ */
            height: auto;
            animation: shakeButt 0.5s ease-in-out infinite; 
        }
        
        /* ë„í† ë¦¬ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .action-acorn { 
            width: 80px; /* í¬ê¸° ì¡°ì ˆ */
            height: auto;
            opacity: 0; 
            margin-top: -50px; /* ë‹¤ëŒì¥ ì—‰ë©ì´ ê·¼ì²˜ì—ì„œ ì‹œì‘ */
            animation: dropAcorn 1s ease-out forwards; 
            animation-delay: 1s; 
            position: absolute; /* ê²¹ì¹˜ê¸° ìœ„í•´ ì ˆëŒ€ ìœ„ì¹˜ */
        }

        @keyframes shakeButt {
            0% { transform: rotate(0deg) translateY(0); } 
            25% { transform: rotate(-10deg) translateY(5px); }
            75% { transform: rotate(10deg) translateY(5px); } 
            100% { transform: rotate(0deg) translateY(0); }
        }
        @keyframes dropAcorn {
            0% { transform: translateY(0) scale(0.5); opacity: 0; } 
            50% { opacity: 1; }
            100% { transform: translateY(120px) scale(1.0); opacity: 1; } /* ì•„ë˜ë¡œ íˆ­ ë–¨ì–´ì§ */
        }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .stats-box { background: #8B4513; color: white; padding: 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .stats-count { font-size: 28px; font-weight: bold; }
        .log-item { background: white; margin: 15px; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .log-place { font-weight: bold; font-size: 16px; color: #333; line-height: 1.3; }
        .log-note { background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 14px; color: #555; border-left: 3px solid #8B4513; }
        .btn-edit { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; background: none; border: none; }

        /* ëª¨ë‹¬ */
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 80%; }
        .modal-input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; }
        .btn-save { background: #8B4513; color: white; }

        .infowindow-content button {
            background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px; font-size: 12px;
        }
        /* --- ê¸°ì¡´ style íƒœê·¸ ì•ˆì— ì¶”ê°€ --- */

        /* êµ­ê°€ë³„ í—¤ë” ìŠ¤íƒ€ì¼ */
        .country-header {
            background-color: #eee;
            padding: 10px 15px;
            font-weight: bold;
            color: #555;
            font-size: 16px;
            border-left: 5px solid #8B4513; /* ë‹¤ëŒì¥ìƒ‰ í¬ì¸íŠ¸ */
            margin-top: 20px;
            margin-bottom: 5px;
        }
        /* ì²« ë²ˆì§¸ í—¤ë”ëŠ” ìœ„ìª½ ì—¬ë°± ì—†ì• ê¸° */
        .country-header:first-child { margin-top: 0; }
    </style>
</head>
<body>
    <div id="intro-screen">
        <div class="intro-container">
            <!-- 1. ë‹¤ëŒì¥ ëŒ€ì¥ (ì œìë¦¬ ê±·ê¸°) -->
            <img src="./squirrel.png" class="intro-walker intro-squirrel" alt="ë‹¤ëŒì¥">
            
            <!-- 2. ë”°ë¼ì˜¤ëŠ” ì œì œ (1ì´ˆ ë’¤ ë“±ì¥) -->
            <img src="./jeje.png" class="intro-walker intro-jeje" alt="ì œì œ">
            
            <!-- 3. íšŒì „í•˜ëŠ” ì§€êµ¬ -->
            <img src="./globe.png" class="intro-globe" alt="ì§€êµ¬ë³¸">
        </div>
        <div class="intro-text">ì§€êµ¬ ì •ë³µí•˜ëŸ¬ ì¶œë™!<br>ë¹¨ë¦¬ì™€ ì œì œ! ğŸ¿ï¸ğŸ’¨ğŸ•</div>
    </div>

    <div id="action-overlay">
        <!-- ì›€ì§ì´ëŠ” ë‹¤ëŒì¥ -->
        <img src="./squirrel.png" class="action-squirrel" alt="ë‹¤ëŒì¥">
        <!-- ë–¨ì–´ì§€ëŠ” ë„í† ë¦¬ -->
        <img src="./acorn.png" class="action-acorn" alt="ë„í† ë¦¬">
        
        <div style="color:white; font-weight:bold; margin-top:140px; font-size:22px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
            ì˜ì—­ í‘œì‹œ ì¤‘... ğŸ’©
        </div>
    </div>

    <div id="map-container">
        <div id="map" style="width: 100%; height: 100%;"></div>
        
        <!-- [ê°œì„ ] ìƒë‹¨ í”Œë¡œíŒ… ë¼ë²¨ (ë¹ ë¥¸ ë°˜ì‘ì†ë„) -->
        <div id="target-label">ì¥ì†Œ íƒìƒ‰ ì¤‘... ğŸ‘€</div>

        <div id="guide-msg">ì› ì•ˆì—ì„œ ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•´<br>ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì°ì–´ì£¼ì„¸ìš”!</div>
        <button id="conquer-btn" onclick="startConquestMode()"><span>ğŸš©</span> ì •ë³µí•˜ê¸°</button>
        <div id="confirm-group">
            <button id="btn-cancel" class="action-btn" onclick="cancelConquestMode()">âœ– ì·¨ì†Œ</button>
            <button id="btn-confirm" class="action-btn" onclick="confirmLocationAndSave()">ğŸ™†â€â™‚ï¸ í™•ì •!</button>
        </div>
    </div>

    <div id="list-container">
        <div class="stats-box">
            <div style="font-size: 14px; opacity: 0.9;">í˜„ì¬ ë‹¤ëŒì¥ì˜ ì •ë³µ í˜„í™©</div>
            <div class="stats-count" id="total-count">0ê³³ ì •ë³µí•¨</div>
            <div style="margin-top: 10px; font-size: 14px;" id="country-stats"></div>
        </div>
        <div id="log-list-area"></div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('map')" id="tab-map"><span class="tab-icon">ğŸ—ºï¸</span>ì§€ë„</div>
        <div class="tab-item" onclick="switchTab('list')" id="tab-list"><span class="tab-icon">ğŸ“œ</span>ì •ë³µ ë¦¬ìŠ¤íŠ¸</div>
    </div>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#8B4513;">ì •ë³µ ê¸°ë¡ ìˆ˜ì • ğŸ¿ï¸</h3>
            <input type="text" id="edit-place" class="modal-input" placeholder="ì¥ì†Œ ì´ë¦„">
            <textarea id="edit-note" class="modal-input" rows="3" placeholder="ë©”ëª¨"></textarea>
            <input type="hidden" id="edit-id">
            <div class="modal-btns">
                <button class="modal-btn" onclick="closeModal()" style="background:#ddd;">ì·¨ì†Œ</button>
                <button class="modal-btn btn-save" onclick="saveEdit()">ì €ì¥</button>
            </div>
            <button onclick="deleteLogFromModal()" style="margin-top:10px; width:100%; background:none; border:none; color:red; cursor:pointer; font-weight:bold;">ğŸ—‘ ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5LgbtPjepR9nuQ4TUjyRknmC9JgKodWo&libraries=places,geometry&callback=initMap">
    </script>

    <script>
        let map;
        let geocoder;
        let placesService;
        let activeSelectionMarker = null;
        let activeCircle = null;
        let allMarkers = {};
        
        // ì£¼ë³€ ê±´ë¬¼ íƒ€ê²Ÿ(íŒŒë€ì ) ê´€ë¦¬ ë°°ì—´
        let targetSpots = [];
        let selectedSpotData = null; 

        // [ì¶”ê°€] ë¼ë²¨ ìš”ì†Œ ì°¸ì¡°
        const targetLabel = document.getElementById('target-label');

        function initMap() {
            setTimeout(() => {
                document.getElementById('intro-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('intro-screen').style.display = 'none'; }, 1000);
            }, 3000);

            geocoder = new google.maps.Geocoder();
            const startPos = { lat: 37.5665, lng: 126.9780 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 17, 
                center: startPos, 
                
                // UI ì»¨íŠ¸ë¡¤ ì„¤ì •
                disableDefaultUI: false, 
                clickableIcons: false,  // ì§€ë„ ìƒì  ì•„ì´ì½˜ í´ë¦­ ë°©ì§€ (ë‹¤ëŒì¥ ë§ˆì»¤ í´ë¦­ ë°©í•´ ì•ˆ ë°›ê²Œ)
                streetViewControl: false, 
                mapTypeControl: false
                
                // styles ì˜µì…˜ì„ ì•„ì˜ˆ ëºìŠµë‹ˆë‹¤. -> ê¸°ë³¸ êµ¬ê¸€ ì§€ë„ë¡œ í‘œì‹œë¨
            });

            try {
                placesService = new google.maps.places.PlacesService(map);
            } catch (e) {
                console.warn("Places ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
            }

            loadConquests(); 

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    map.setCenter(pos);
                    
                    // [ë‚´ ìœ„ì¹˜] = íƒí—˜ê°€ ë‹¤ëŒì¥ (squirrel.png)
                    new google.maps.Marker({ 
                        position: pos, 
                        map: map, 
                        icon: {
                            url: "./squirrel.png",
                            scaledSize: new google.maps.Size(70, 70), // ë‹¤ëŒì¥ëŠ” ì¢€ í¬ê²Œ
                            anchor: new google.maps.Point(35, 35)
                        },
                        zIndex: 200 // ë‹¤ë¥¸ ë§ˆì»¤ë³´ë‹¤ ìœ„ì— ë³´ì´ê²Œ
                    });
                });
            }
        }

        function startConquestMode() {
            if (!navigator.geolocation) { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            
            navigator.geolocation.getCurrentPosition((position) => {
                const currentLat = position.coords.latitude;
                const currentLng = position.coords.longitude;
                const currentPos = { lat: currentLat, lng: currentLng };

                map.setCenter(currentPos);
                map.setZoom(18);

                clearConquestUI();

                // [ìˆ˜ì •] íƒìƒ‰ ë°˜ê²½ í™•ëŒ€ (100 -> 150)
                activeCircle = new google.maps.Circle({
                    strokeColor: "#8B4513", strokeOpacity: 0.8, strokeWeight: 2,
                    fillColor: "#8B4513", fillOpacity: 0.1,
                    map: map, center: currentPos, radius: 150,
                    zIndex: 1, clickable: false 
                });

                activeSelectionMarker = new google.maps.Marker({
                    position: currentPos, 
                    map: map, 
                    draggable: true,
                    icon: {
                        url: "./acorn.png",
                        scaledSize: new google.maps.Size(60, 60), // ë“œë˜ê·¸í•  ë•Œ ì˜ ë³´ì´ê²Œ í¼ì§í•˜ê²Œ
                        anchor: new google.maps.Point(30, 30)
                    },
                    animation: google.maps.Animation.DROP, 
                    zIndex: 9999
                });

                // [1] ì£¼ë³€ ê±´ë¬¼ ì •ë³´ ë¡œë“œ (íŒŒë€ ì )
                searchNearbyPlaces(currentPos);

                // [2] ë“œë˜ê·¸ ì‹œì‘: ë¼ë²¨ í‘œì‹œ
                activeSelectionMarker.addListener('dragstart', () => {
                    targetLabel.style.display = 'block';
                    targetLabel.innerText = "ì–´ë””ì— ì‹¬ì„ê¹Œ? ğŸ‘€";
                    targetLabel.style.borderColor = "#8B4513";
                    targetLabel.style.color = "#8B4513";
                });

                // [3] ë“œë˜ê·¸ ì¤‘: íŒŒë€ ì  ê·¼ì²˜ë©´ ìì„ íš¨ê³¼ (DOM ì§ì ‘ ì œì–´ -> ë¹ ë¦„)
                activeSelectionMarker.addListener('drag', () => {
                    checkDragHover();
                });

                // [4] ë“œë˜ê·¸ ì¢…ë£Œ: íŒŒë€ ì ì— ì•ˆ ê±¸ë ¸ìœ¼ë©´ Places APIë¡œ "ê°€ì¥ ê°€ê¹Œìš´ ê±´ë¬¼" ê²€ìƒ‰
                // [ìˆ˜ì • 1] startConquestMode í•¨ìˆ˜ ë‚´ë¶€ì˜ 'dragend' ë¦¬ìŠ¤ë„ˆë¥¼ ì´ê±¸ë¡œ êµì²´í•˜ì„¸ìš”.
                activeSelectionMarker.addListener('dragend', () => {
                    // [í•µì‹¬ í•´ê²°ì±…] ë§ˆì»¤ë¥¼ ë†“ëŠ” ìˆœê°„, ê¸°ì¡´ì— ì €ì¥ëœ ì¥ì†Œ ì •ë³´ë¥¼ 'ë¬´ì¡°ê±´' ì‚­ì œí•©ë‹ˆë‹¤.
                    selectedSpotData = null; 
                    
                    // ë¼ë²¨ë„ "í™•ì¸ ì¤‘"ìœ¼ë¡œ ì¦‰ì‹œ ë³€ê²½í•´ì„œ ì‹œê°ì ìœ¼ë¡œ í”¼ë“œë°±ì„ ì¤ë‹ˆë‹¤.
                    targetLabel.innerText = "ìœ„ì¹˜ í™•ì¸ ì¤‘... â³";
                    targetLabel.style.color = "#888";
                    targetLabel.style.borderColor = "#888";

                    const pos = activeSelectionMarker.getPosition();
                    
                    // ë°”ë¡œ API ê²€ìƒ‰ ì‹œì‘
                    findExactBuildingName(pos);
                });

                document.getElementById('conquer-btn').style.display = 'none';
                document.getElementById('confirm-group').style.display = 'flex';
                document.getElementById('guide-msg').style.display = 'block';
                targetLabel.style.display = 'block'; // ì‹œì‘í•  ë•Œ ë¼ë²¨ ë„ìš°ê¸°

            }, () => {
                alert("GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        function searchNearbyPlaces(center) {
            if (!placesService) return;
            const request = {
                location: center,
                radius: 150, // ê²€ìƒ‰ ë°˜ê²½ í™•ëŒ€
                type: ['establishment'] 
            };
            placesService.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    results.forEach(place => createBlueDot(place));
                }
            });
        }

        function createBlueDot(place) {
            const dot = new google.maps.Circle({
                strokeColor: "#2196F3", strokeOpacity: 0.8, strokeWeight: 1,
                fillColor: "#2196F3", fillOpacity: 0.5,
                map: map, center: place.geometry.location, radius: 6,
                zIndex: 500, clickable: false
            });

            targetSpots.push({
                marker: dot,
                location: place.geometry.location,
                name: place.name,
                placeId: place.place_id
            });
        }

        // ë“œë˜ê·¸ ì¤‘ ìì„ íš¨ê³¼ (UI ë”œë ˆì´ ì—†ì´ ë¼ë²¨ ì—…ë°ì´íŠ¸)
        function checkDragHover() {
            if (targetSpots.length === 0) return;

            const acornPos = activeSelectionMarker.getPosition();
            let nearestSpot = null;
            let minDistance = 9999;

            targetSpots.forEach(spot => {
                if (google.maps.geometry) {
                    const dist = google.maps.geometry.spherical.computeDistanceBetween(acornPos, spot.location);
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestSpot = spot;
                    }
                }
            });

            // [ìˆ˜ì •] ê°ì§€ ê±°ë¦¬ë¥¼ 15m -> 30më¡œ ì™„í™”í•˜ì—¬ ë” ì˜ ë¶™ê²Œ í•¨
            if (nearestSpot && minDistance < 30) {
                selectedSpotData = nearestSpot;
                targetLabel.innerText = "âœ¨ " + nearestSpot.name;
                targetLabel.style.borderColor = "#2196F3"; // íŒŒë€ìƒ‰ ê°•ì¡°
                targetLabel.style.color = "#1565C0";
            } else {
                selectedSpotData = null;
                targetLabel.innerText = "ìƒˆë¡œìš´ ì¥ì†Œ ê°œì²™ ì¤‘... ğŸŒ±";
                targetLabel.style.borderColor = "#8B4513";
                targetLabel.style.color = "#8B4513";
            }
        }

        // [ì¤‘ìš”] ë“œë˜ê·¸ ëë‚¬ì„ ë•Œ APIë¡œ ì •í™•í•œ ê±´ë¬¼ëª… ê°€ì ¸ì˜¤ê¸°
        // [ìˆ˜ì •ëœ í•¨ìˆ˜] Places API ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ ì „í™˜
// [ìˆ˜ì • 2] ì´ í•¨ìˆ˜ ì „ì²´ë¥¼ ë®ì–´ì”Œìš°ì„¸ìš”.
        function findExactBuildingName(latLng) {
            // 1. Places APIì— ì£¼ë³€ ì •ë³´ ìš”ì²­
            const request = {
                location: latLng,
                rankBy: google.maps.places.RankBy.DISTANCE, // ê±°ë¦¬ìˆœ (ê°€ì¥ ê°€ê¹Œìš´ê±°)
                type: 'point_of_interest' // ëª¨ë“  ì£¼ìš” ì‹œì„¤ë¬¼ ê²€ìƒ‰
            };

            placesService.nearbySearch(request, (results, status) => {
                // 2. ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆê³ , ëª©ë¡ì´ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    const nearestPlace = results[0];
                    const placeName = nearestPlace.name;

                    // ë¼ë²¨ ì—…ë°ì´íŠ¸
                    targetLabel.innerText = "ğŸ“ " + placeName;
                    targetLabel.style.borderColor = "#8B4513";
                    targetLabel.style.color = "#8B4513";

                    // ë°ì´í„° ì €ì¥
                    selectedSpotData = {
                        name: placeName,
                        placeId: nearestPlace.place_id,
                        location: nearestPlace.geometry.location
                    };
                } 
                // 3. ê±´ë¬¼ì´ ì•ˆ ì¡íˆë©´(ZERO_RESULTS ë“±) -> ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ ì¦‰ì‹œ ì „í™˜
                else {
                    // ì—¬ê¸°ê°€ ì‹¤í–‰ë˜ì–´ì•¼ "ì´ì „ ì´ë¦„"ì´ ì•ˆ ë‚¨ê³  "ì£¼ì†Œ"ë¡œ ë°”ë€œ
                    updateAddressFallback(latLng);
                }
            });
        }

        // [ìˆ˜ì •ëœ í•¨ìˆ˜] ì£¼ì†Œ ê²€ìƒ‰ ë¡œì§ ê°•í™” (ì•„íŒŒíŠ¸ ë™/í˜¸ìˆ˜ í‘œí˜„)
        function updateAddressFallback(latLng) {
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    // ì£¼ì†Œ ë¶„ì„
                    let bestName = "";
                    let dongName = "";
                    let buildingName = "";

                    // ì£¼ì†Œ êµ¬ì„±ìš”ì†Œ ëœ¯ì–´ë³´ê¸°
                    results[0].address_components.forEach(comp => {
                        if (comp.types.includes('premise')) buildingName = comp.long_name; // ê±´ë¬¼ëª… (ex: 103ë™)
                        if (comp.types.includes('sublocality_level_2') || comp.types.includes('neighborhood')) dongName = comp.long_name; // ë™ (ex: ì‚¬ë‹¹ë™)
                        if (comp.types.includes('point_of_interest')) bestName = comp.long_name; // í˜¹ì‹œë¼ë„ ì¡íˆëŠ” ê±´ë¬¼ëª…
                    });

                    // ê°€ì¥ ì ì ˆí•œ ì´ë¦„ ì¡°í•©í•˜ê¸°
                    // 1ìˆœìœ„: í¬ë§·ëœ ì£¼ì†Œì˜ ì•ë¶€ë¶„ (ê±´ë¬¼ëª… í¬í•¨ëœ ê²½ìš°)
                    // êµ¬ê¸€ ì£¼ì†Œ í¬ë§·: "ëŒ€í•œë¯¼êµ­ ì„œìš¸íŠ¹ë³„ì‹œ XXêµ¬ XXë™ 123-4 AAì•„íŒŒíŠ¸ 103ë™"
                    const formatted = results[0].formatted_address;
                    
                    // "103ë™" ê°™ì€ êµ¬ì²´ì ì¸ ê±´ë¬¼ ì •ë³´ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì”€
                    if (buildingName) {
                        bestName = `${dongName} ${buildingName}`;
                    } else if (bestName) {
                        // do nothing, use bestName
                    } else {
                        // ë„ë¡œëª… ì£¼ì†Œë‚˜ ì§€ë²ˆ ì£¼ì†Œì—ì„œ ì•ë¶€ë¶„(êµ­ê°€, ì‹œ) ë–¼ê³  ë‚˜ë¨¸ì§€
                        // ì˜ˆ: "ëŒ€í•œë¯¼êµ­ ì„œìš¸íŠ¹ë³„ì‹œ ë™ì‘êµ¬ ì‚¬ë‹¹ë™" -> "ë™ì‘êµ¬ ì‚¬ë‹¹ë™"
                        const parts = formatted.split(' ');
                        if(parts.length > 2) bestName = parts.slice(2).join(' ');
                        else bestName = formatted;
                    }

                    targetLabel.innerText = "ğŸ  " + bestName;
                    targetLabel.style.borderColor = "#555";
                    targetLabel.style.color = "#333";
                    
                    selectedSpotData = null; // ì¼ë°˜ ì¢Œí‘œ ëª¨ë“œ
                } else {
                    targetLabel.innerText = "ğŸš© ìœ„ì¹˜ ì§€ì •ë¨";
                    console.log("Geocoding ì‹¤íŒ¨: " + status);
                }
            });
        }

        function updateAddressFallback(latLng) {
            geocoder.geocode({ location: latLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const highlightName = getBuildingOrRoadName(results);
                    targetLabel.innerText = "ğŸ  " + highlightName;
                    targetLabel.style.borderColor = "#8B4513";
                    targetLabel.style.color = "#555";
                    selectedSpotData = null; // ì¼ë°˜ ì¢Œí‘œ ì €ì¥ ëª¨ë“œ
                } else {
                    targetLabel.innerText = "ğŸš© ìœ„ì¹˜ ì§€ì •ë¨";
                }
            });
        }

        function getBuildingOrRoadName(results) {
            let building = "", dong = "", road = "";
            const components = results[0].address_components;
            components.forEach(c => {
                const t = c.types;
                if (t.includes('point_of_interest') || t.includes('establishment') || t.includes('premise')) building = c.long_name;
                if (t.includes('sublocality_level_2') || t.includes('neighborhood')) dong = c.long_name;
                if (t.includes('route')) road = c.long_name;
            });
            if (building) return building; // ê±´ë¬¼ëª… ìš°ì„ 
            if (road) return `${dong} ${road}`;
            return "ì´ë¦„ ëª¨ë¥¼ ê³³";
        }

        function cancelConquestMode() {
            clearConquestUI();
            targetLabel.style.display = 'none';
            document.getElementById('conquer-btn').style.display = 'flex';
            document.getElementById('confirm-group').style.display = 'none';
            document.getElementById('guide-msg').style.display = 'none';
        }

        function clearConquestUI() {
            if(activeSelectionMarker) activeSelectionMarker.setMap(null);
            if(activeCircle) activeCircle.setMap(null);
            targetSpots.forEach(spot => spot.marker.setMap(null));
            targetSpots = [];
            selectedSpotData = null;
            activeSelectionMarker = null;
            activeCircle = null;
        }

        function confirmLocationAndSave() {
            if(!activeSelectionMarker) return;
            const overlay = document.getElementById('action-overlay');
            overlay.style.display = 'flex';

            setTimeout(() => {
                if (selectedSpotData) {
                    // ê±´ë¬¼/íŒŒë€ ì  ë°ì´í„°ë¡œ ì €ì¥
                    saveWithPlaceData(selectedSpotData);
                } else {
                    // ì¼ë°˜ ì¢Œí‘œ ë°ì´í„°ë¡œ ì €ì¥
                    const pos = activeSelectionMarker.getPosition();
                    saveData(pos.lat(), pos.lng());
                }
                overlay.style.display = 'none';
                cancelConquestMode(); 
            }, 2500); 
        }

        function saveWithPlaceData(spot) {
            geocoder.geocode({ 'placeId': spot.placeId }, (results, status) => {
                let country = "ë¯¸ì§€ì˜ ë•…", flag = "ğŸ³ï¸";
                let fullAddress = spot.name; // ê¸°ë³¸ê°’ì€ ê±´ë¬¼ëª…

                if (status === "OK" && results[0]) {
                    // ìƒì„¸ ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
                    const detail = getFullDetailedAddress(results[0].address_components);
                    fullAddress = `${detail} ${spot.name}`; // "ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ ìŠ¤íƒ€ë²…ìŠ¤" ì‹

                    results[0].address_components.forEach(comp => {
                        if (comp.types.includes("country")) {
                            country = comp.long_name;
                            if(country === "ëŒ€í•œë¯¼êµ­") flag = "ğŸ‡°ğŸ‡·"; else if(country === "ë¯¸êµ­") flag = "ğŸ‡ºğŸ‡¸"; else if(country === "ì¼ë³¸") flag = "ğŸ‡¯ğŸ‡µ";
                        }
                    });
                }
                saveToStorage({ lat: spot.location.lat(), lng: spot.location.lng(), country, flag, placeName: fullAddress });
            });
        }

        function saveData(lat, lng) {
            geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                let country = "ë¯¸ì§€ì˜ ë•…", fullAddress = "ì–´ë”˜ê°€", flag = "ğŸ³ï¸";
                if (status === "OK" && results[0]) {
                    fullAddress = getFullDetailedAddress(results[0].address_components);
                    results[0].address_components.forEach(comp => {
                        if (comp.types.includes("country")) {
                            country = comp.long_name;
                            if(country === "ëŒ€í•œë¯¼êµ­") flag = "ğŸ‡°ğŸ‡·"; else if(country === "ë¯¸êµ­") flag = "ğŸ‡ºğŸ‡¸"; else if(country === "ì¼ë³¸") flag = "ğŸ‡¯ğŸ‡µ";
                        }
                    });
                }
                saveToStorage({ lat, lng, country, flag, placeName: fullAddress });
            });
        }

        function saveToStorage(data) {
            const newConquest = {
                id: Date.now(),
                lat: data.lat, lng: data.lng,
                time: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString(),
                country: data.country, placeName: data.placeName, flag: data.flag,
                note: "ì˜ì—­ í‘œì‹œ ì™„ë£Œ! ë“ ë“ í•˜ë‹¤."
            };
            let list = getList();
            list.push(newConquest);
            saveList(list);
            addMarker(newConquest);
            if(navigator.vibrate) navigator.vibrate(200);
        }

        function getFullDetailedAddress(components) {
            let parts = { admin: '', locality: '', sublocality: '', dong: '', road: '', building: '' };
            components.forEach(comp => {
                const t = comp.types;
                if(t.includes('administrative_area_level_1')) parts.admin = comp.long_name;
                else if(t.includes('locality') || t.includes('administrative_area_level_2')) parts.locality = comp.long_name;
                else if(t.includes('sublocality_level_1')) parts.sublocality = comp.long_name;
                else if(t.includes('sublocality_level_2') || t.includes('neighborhood')) parts.dong = comp.long_name;
                else if(t.includes('route')) parts.road = comp.long_name;
            });
            // ê±´ë¬¼ëª…ì€ ì´ë¯¸ ì•ì—ì„œ ë¶™ì˜€ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„  ì£¼ì†Œë§Œ
            let addressArray = [parts.locality, parts.sublocality, parts.dong, parts.road];
            return addressArray.filter(p => p).join(' ');
        }

        function addMarker(data) {
            // [ì •ë³µ ë§ˆì»¤] = ë„í† ë¦¬ (acorn.png)
            const marker = new google.maps.Marker({
                position: { lat: data.lat, lng: data.lng },
                map: map, 
                icon: {
                    url: "./acorn.png",
                    scaledSize: new google.maps.Size(40, 40), // ì§€ë„ì— ë°•íŒ ê±´ ì ë‹¹í•œ í¬ê¸°ë¡œ
                    anchor: new google.maps.Point(20, 20)
                },
                zIndex: 100
            });

            // 2. ì •ë³µí•œ ì˜ì—­ í‘œì‹œ (ë°˜íˆ¬ëª…í•œ ì›) - ì´ê±´ ê·¸ëŒ€ë¡œ ìœ ì§€
            const territoryCircle = new google.maps.Circle({
                strokeColor: "#FF5722", 
                strokeOpacity: 0.8,
                strokeWeight: 1,
                fillColor: "#FF5722",   
                fillOpacity: 0.35,      
                map: map,
                center: { lat: data.lat, lng: data.lng },
                radius: 40,             
                zIndex: 50
            });

            const infoContent = `
                <div class="infowindow-content" style="text-align:center; padding:5px;">
                    <div style="font-size:14px; font-weight:bold; margin-bottom:4px; max-width:200px; word-break:keep-all;">${data.placeName}</div>
                    <div style="font-size:11px; color:#666;">${data.time}</div>
                    <button onclick="deleteConquestGlobal(${data.id})">ğŸ—‘ ì‚­ì œ</button>
                </div>
            `;
            const infoWindow = new google.maps.InfoWindow({ content: infoContent });
            
            marker.addListener("click", () => infoWindow.open(map, marker));
            territoryCircle.addListener("click", () => infoWindow.open(map, marker));

            allMarkers[data.id] = { marker: marker, circle: territoryCircle };
        }

        window.deleteConquestGlobal = function(id) {
            if(!confirm("ì •ë§ ì´ ë„í† ë¦¬ë¥¼ íŒŒë‚´ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            let list = getList();
            list = list.filter(item => item.id !== id);
            saveList(list); 

            // ì§€ë„ì—ì„œ ë§ˆì»¤ì™€ ì›(ì˜ì—­) ëª¨ë‘ ì œê±°
            if (allMarkers[id]) { 
                allMarkers[id].marker.setMap(null); // ë§ˆì»¤ ì‚­ì œ
                allMarkers[id].circle.setMap(null); // ì› ì‚­ì œ
                delete allMarkers[id]; 
            }
            
            closeModal();
        }

        function getList() { return JSON.parse(localStorage.getItem('conquestList')) || []; }
        function saveList(list) { localStorage.setItem('conquestList', JSON.stringify(list)); renderList(); }
        
        function loadConquests() {
            allMarkers = {}; 
            getList().forEach(item => addMarker(item));
            renderList();
        }

        function renderList() {
            const list = getList(); // ìˆœì„œ ë°˜ì „ ì—†ì´ ì›ë³¸ ê°€ì ¸ì˜´ (ìµœì‹ ìˆœ ì •ë ¬ì€ ì•„ë˜ì—ì„œ)
            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (IDê°€ ì‹œê°„ ê¸°ë°˜ì´ë¯€ë¡œ ID í° ê²Œ ìµœì‹ )
            list.sort((a, b) => b.id - a.id);

            const container = document.getElementById('log-list-area');
            container.innerHTML = "";
            document.getElementById('total-count').innerText = `${list.length}ê°œì˜ ë„í† ë¦¬ ì‹¬ìŒ`;
            
            // í†µê³„ í‘œì‹œ
            const countryCounts = {};
            list.forEach(item => { countryCounts[item.country] = (countryCounts[item.country] || 0) + 1; });
            let statsText = [];
            for (const [country, count] of Object.entries(countryCounts)) statsText.push(`${country} ${count}`);
            document.getElementById('country-stats').innerText = statsText.join('  |  ');

            // [í•µì‹¬] êµ­ê°€ë³„ ê·¸ë£¹í•‘
            // ë°ì´í„°ë¥¼ { "ëŒ€í•œë¯¼êµ­": [item1, item2], "í”„ë‘ìŠ¤": [item3] } í˜•íƒœë¡œ ë§Œë“¦
            const grouped = {};
            list.forEach(item => {
                const key = item.country || "ë¯¸ì§€ì˜ ë•…";
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(item);
            });

            // ê·¸ë£¹í•‘ëœ ë°ì´í„°ë¥¼ í™”ë©´ì— ì¶œë ¥
            for (const [country, items] of Object.entries(grouped)) {
                // 1. êµ­ê°€ í—¤ë” ìƒì„± ([ ëŒ€í•œë¯¼êµ­ ])
                const header = document.createElement('div');
                header.className = 'country-header';
                header.innerText = `[ ${country} ]`;
                container.appendChild(header);

                // 2. í•´ë‹¹ êµ­ê°€ì˜ ì•„ì´í…œë“¤ ìƒì„±
                items.forEach(item => {
                    const div = document.createElement('div'); 
                    div.className = 'log-item';
                    div.innerHTML = `
                        <div class="log-header">
                            <div><span style="font-size:24px; margin-right:5px;">${item.flag}</span> <span class="log-place">${item.placeName}</span></div>
                            <button class="btn-edit" onclick="openEditModal(${item.id})">âœ</button>
                        </div>
                        <div style="font-size:12px; color:#777; margin-bottom:8px;">${item.time}</div>
                        <div class="log-note">${item.note}</div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function openEditModal(id) {
            const item = getList().find(x => x.id === id);
            if(item) {
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-place').value = item.placeName;
                document.getElementById('edit-note').value = item.note;
                document.getElementById('edit-modal').style.display = 'flex';
            }
        }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        
        function saveEdit() {
            const id = parseInt(document.getElementById('edit-id').value);
            let list = getList();
            const index = list.findIndex(x => x.id === id);
            if(index !== -1) {
                list[index].placeName = document.getElementById('edit-place').value;
                list[index].note = document.getElementById('edit-note').value;
                saveList(list); 
                if(allMarkers[id]) allMarkers[id].setMap(null);
                addMarker(list[index]); 
                closeModal();
            }
        }
        
        function deleteLogFromModal() {
            const id = parseInt(document.getElementById('edit-id').value);
            deleteConquestGlobal(id);
        }
        
        function switchTab(tabName) {
            if (tabName === 'map') {
                document.getElementById('map-container').style.display = 'block';
                document.getElementById('list-container').style.display = 'none';
                document.getElementById('tab-map').classList.add('active');
                document.getElementById('tab-list').classList.remove('active');
            } else {
                document.getElementById('map-container').style.display = 'none';
                document.getElementById('list-container').style.display = 'block';
                document.getElementById('tab-map').classList.remove('active');
                document.getElementById('tab-list').classList.add('active');
                renderList();
            }
        }
    </script>
    <script>
        // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ! ğŸ¿ï¸'))
                .catch((err) => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨ ã… ã… ', err));
        }
    </script>
</body>
</html>
